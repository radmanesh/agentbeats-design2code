FROM ghcr.io/astral-sh/uv:python3.12-trixie

RUN adduser agentbeats
USER agentbeats
RUN mkdir -p /home/agentbeats/.cache/uv
WORKDIR /home/agentbeats/tutorial

COPY pyproject.toml uv.lock README.md ./
COPY src src

RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/uv,uid=1000 \
    uv sync --locked

# Install system dependencies
USER root
RUN apt-get update && apt-get install -y git && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*
USER agentbeats

# Install evaluation dependencies
RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/uv,uid=1000 \
    uv pip install --no-cache-dir datasets pillow opencv-python-headless numpy beautifulsoup4 colormath scipy playwright && \
    uv pip install --no-cache-dir torch torchvision --index-url https://download.pytorch.org/whl/cpu

# Install CLIP from GitHub (not on PyPI)
RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/uv,uid=1000 \
    uv pip install --no-cache-dir "git+https://github.com/openai/CLIP.git"

# Install Playwright browsers
RUN uv run playwright install chromium

# Install Playwright system dependencies (must run as root)
USER root
RUN uv run playwright install-deps chromium
# Clean up
# RUN rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* && \
#     apt-get remove -y git && \
#     apt-get autoremove -y && \
#     apt-get clean && \
#     # Remove documentation
#     rm -rf /usr/local/share/doc /usr/local/share/man && \
#     # Clean up apt cache and temp files
#     find /usr/local -name "*.pyc" -delete && \
#     find /usr/local -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true && \
#     find /usr/local -name "*.dist-info" -type d -exec rm -rf {} + 2>/dev/null || true
USER agentbeats

COPY scenarios scenarios
COPY assets assets

ENTRYPOINT ["uv", "run", "scenarios/design2code/design2code_evaluator.py"]
CMD ["--host", "0.0.0.0"]
EXPOSE 9009
