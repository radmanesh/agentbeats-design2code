FROM ghcr.io/astral-sh/uv:python3.12-trixie

RUN adduser agentbeats
USER agentbeats
RUN mkdir -p /home/agentbeats/.cache/uv
WORKDIR /home/agentbeats/tutorial

COPY pyproject.toml uv.lock README.md ./
COPY src src

RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/uv,uid=1000 \
    uv sync --locked

# Install additional dependencies for Design2Code evaluation
USER root
RUN apt-get update && apt-get install -y \
    git \
    libglib2.0-0 \
    && rm -rf /var/lib/apt/lists/*
USER agentbeats

RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/uv,uid=1000 \
    uv pip install datasets pillow opencv-python-headless beautifulsoup4 colormath scipy scikit-learn playwright torch torchvision

# Install CLIP from GitHub (not on PyPI)
RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/uv,uid=1000 \
    uv pip install "git+https://github.com/openai/CLIP.git"

# Clean up to free space before installing Playwright browsers
USER root
RUN apt-get clean && \
    rm -rf /tmp/* /var/tmp/* && \
    find /usr/local -name "*.pyc" -delete && \
    find /usr/local -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true
USER agentbeats

# Install Playwright browsers with cache mount
RUN \
    --mount=type=cache,target=/home/agentbeats/.cache/ms-playwright,uid=1000 \
    uv run playwright install chromium

COPY scenarios scenarios
COPY assets assets

ENTRYPOINT ["uv", "run", "scenarios/design2code/design2code_evaluator.py"]
CMD ["--host", "0.0.0.0"]
EXPOSE 9009
